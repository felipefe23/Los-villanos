<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViviendaDigital ¬∑ Iniciar Sesi√≥n</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>
<body>
  <main class="login-only" aria-label="Formulario de inicio de sesi√≥n">
    <div class="brand-pill">
      <span class="brand-icon">üè†</span>
      <span>ViviendaDigital</span>
    </div>

    <section class="form-card">
      <h1>Inicia sesi√≥n</h1>
      <p class="subtitle">Accede con tu correo y contrase√±a registrados.</p>

      <form id="loginForm" novalidate>
        <label class="field">
          <span>Correo electr√≥nico</span>
          <input type="email" name="email" placeholder="ejemplo@correo.com" autocomplete="email" required>
        </label>

        <label class="field">
          <span>Contrase√±a</span>
          <div class="password-field">
            <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required>
            <button type="button" class="toggle-pass" aria-label="Mostrar u ocultar contrase√±a">
              <span id="eye-icon">üëÅÔ∏è</span>
            </button>
          </div>
        </label>

        <button type="submit" class="btn-primary">
          <span class="btn-label">Ingresar</span>
          <span class="btn-spinner" aria-hidden="true"></span>
        </button>
      </form>

      <p id="formMessage" class="form-message" role="alert" aria-live="polite"></p>

      <div class="helper-links">
        <a href="{{ url_for('comprador_register_view') }}">Crear cuenta de comprador</a>
        <a href="{{ url_for('vendedor_register_view') }}">Crear cuenta de vendedor</a>
      </div>
    </section>
  </main>

<script>
    // Limpiar usuarioActual al cargar la pagina en secion
  try { localStorage.removeItem('usuarioActual'); } catch (e) { /* ignore */ }
    const form = document.getElementById('loginForm');
    const messageEl = document.getElementById('formMessage');
    const submitBtn = form.querySelector('button[type="submit"]');
    const togglePassBtn = form.querySelector('.toggle-pass');
    const passwordInput = form.querySelector('input[name="password"]');
    const eyeIcon = document.getElementById('eye-icon');
    const serverErrorMessage = {{ (error_message or '') | tojson | safe }};

    if (serverErrorMessage) {
      messageEl.textContent = serverErrorMessage;
      messageEl.classList.add('error');
    }

    const redirectByRole = {
      admin: '/admin',
      administrador: '/admin',
      vendedor: '/vendedor',
      comprador: '/comprador'
    };

    togglePassBtn.addEventListener('click', () => {
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      eyeIcon.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
      passwordInput.focus();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      // üîπ Activar ruedita de carga
      submitBtn.classList.add('is-loading');
      submitBtn.setAttribute('disabled', true);

      const formData = Object.fromEntries(new FormData(form).entries());
      const payload = {
        email: (formData.email || '').trim().toLowerCase(),
        password: (formData.password || '').trim(),
        tipo_usuario: (formData.tipo_usuario || '').trim().toLowerCase()
      };

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok) {
                                            // Error de archivos locales
          try {
            if (data.user) {
              localStorage.setItem('usuarioActual', JSON.stringify(data.user));
            }
          } catch (e) {
            console.warn('No se pudo guardar usuario en localStorage', e);
          }

          if (data.redirect) {
            try {
              await fetch('/api/me', { credentials: 'include' });
            } catch (e) {
            }
            window.location.href = data.redirect;
            return;
          }
          messageEl.textContent = data.message || 'Login exitoso.';
          messageEl.classList.remove('error');
        } else {
          messageEl.textContent = data.error || 'Error en el login.';
          messageEl.classList.add('error');
        }
      } catch (err) {
        messageEl.textContent = 'Error de red. Int√©ntalo nuevamente.';
        messageEl.classList.add('error');
      } finally {
        // üîπ Desactivar ruedita de carga
        submitBtn.classList.remove('is-loading');
        submitBtn.removeAttribute('disabled');
      }
    });
</script>

</body>
</html>
