<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViviendaDigital Â· Iniciar SesiÃ³n</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>
<body>
  <main class="login-only" aria-label="Formulario de inicio de sesiÃ³n">
    <div class="brand-pill">
      <span class="brand-icon">ğŸ </span>
      <span>ViviendaDigital</span>
    </div>

    <section class="form-card">
      <h1>Inicia sesiÃ³n</h1>
      <p class="subtitle">Accede con tu correo y contraseÃ±a registrados.</p>

      <form id="loginForm" novalidate>
        <label class="field">
          <span>Correo electrÃ³nico</span>
          <input type="email" name="email" placeholder="ejemplo@correo.com" autocomplete="email" required>
        </label>

        <label class="field">
          <span>ContraseÃ±a</span>
          <div class="password-field">
            <input type="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" required>
            <button type="button" class="toggle-pass" aria-label="Mostrar u ocultar contraseÃ±a">ğŸ‘ï¸</button>
          </div>
        </label>

        <button type="submit" class="btn-primary">
          <span class="btn-label">Ingresar</span>
          <span class="btn-spinner" aria-hidden="true"></span>
        </button>
      </form>

      <p id="formMessage" class="form-message" role="alert" aria-live="polite"></p>

      <div class="helper-links">
        <a href="{{ url_for('comprador_register_view') }}">Crear cuenta de comprador</a>
        <a href="{{ url_for('vendedor_register_view') }}">Registrar vendedor</a>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById('loginForm');
    const messageEl = document.getElementById('formMessage');
    const submitBtn = form.querySelector('button[type="submit"]');
    const togglePassBtn = form.querySelector('.toggle-pass');
    const passwordInput = form.querySelector('input[type="password"]');

    // mapa de rutas segun rol para dirigir al panel correcto
    const redirectByRole = {
      admin: '/admin',
      administrador: '/admin',
      vendedor: '/vendedor',
      comprador: '/comprador'
    };

    togglePassBtn.addEventListener('click', () => {
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      togglePassBtn.textContent = 'ğŸ‘ï¸';
      passwordInput.focus();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const formData = new FormData(form);
      const email = formData.get('email').trim();
      const password = formData.get('password').trim();

      messageEl.textContent = '';
      messageEl.classList.remove('success', 'error');

      // vuelve con error rapido si los datos basicos no cumplen
      if (!/^.{2,}@[^@]+\.[^@]+$/.test(email)) {
        messageEl.textContent = 'Introduce un correo vÃ¡lido.';
        messageEl.classList.add('error');
        return;
      }

      if (!/^(?=.*\d).{8,}$/.test(password)) {
        messageEl.textContent = 'La contraseÃ±a debe incluir 8 caracteres y al menos un nÃºmero.';
        messageEl.classList.add('error');
        return;
      }

      submitBtn.disabled = true;
      form.classList.add('is-loading');

      try {
        // valida credenciales en la api y recibe los datos del usuario
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Error al iniciar sesiÃ³n');
        }

        const user = result.user || {};
        localStorage.setItem('usuarioActual', JSON.stringify(user));

        messageEl.textContent = result.message || 'Ingreso exitoso.';
        messageEl.classList.add('success');

        const role = String(user.tipo_usuario || '').toLowerCase();
        // si el rol no esta configurado vuelve al inicio
        const destination = redirectByRole[role] || '/';

        setTimeout(() => {
          window.location.href = destination;
        }, 600);
      } catch (error) {
        messageEl.textContent = error.message || 'No se pudo iniciar sesiÃ³n.';
        messageEl.classList.add('error');
        submitBtn.disabled = false;
        form.classList.remove('is-loading');
      }
    });
  </script>
</body>
</html>
