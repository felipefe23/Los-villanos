<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Vendedor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/vendedor.css') }}">
</head>
<body>
  <header class="modern-header">
  <div class="header-left">
    <h1>Panel del Vendedor</h1>
    <p class="subtitle">Administra tus propiedades publicadas y agrega nuevas f√°cilmente.</p>
  </div>
  
  <div class="header-right">
    <div class="user-chip">
      <span class="avatar">JC</span>
      <span class="username">Joaqu√≠n Contreras</span>
    </div>
    <a href="{{ url_for('landing') }}" class="logout-btn">Cerrar sesi√≥n</a>
  </div>
</header>

  <main>
    <div class="side-panel">
      <button type="button" class="toggle-btn" data-target="formPanel">
        ‚ûï Agregar Propiedad
      </button>

      <section class="panel">
        <button type="button" id="reloadBtn" style="margin-bottom:10px; padding:6px 10px;">üìã Actualizar lista</button>
        <ul id="propList">
          <li>No hay propiedades cargadas.</li>
        </ul>
      </section>
    </div>

    <section class="map-wrapper">
      <h2>Mapa</h2>
      <div id="map"></div>
      <div class="map-legend">
        <div>- Haz clic en el mapa para capturar las coordenadas.</div>
        <div>- Los marcadores muestran las propiedades publicadas.</div>
      </div>
    </section>
  </main>

  <div id="formPanel">
    <button type="button" class="close-btn" onclick="cerrarForm()">‚úñ</button>
    <form id="propForm">
      <h2>Agregar propiedad</h2>
      <label>
        Nombre
        <input type="text" name="nombre" id="nombre" placeholder="Casa en Providencia" required>
      </label>
      <label>
        Precio (CLP)
        <input type="number" name="precio" id="precio" placeholder="180000000" min="0" required>
      </label>
      <label>
        Localizaci√≥n
        <input type="text" name="localizacion" id="localizacion" placeholder="Calle, comuna" required>
      </label>
      <label>
        Tipo
        <select name="tipo" id="tipo" required>
          <option value="">Selecciona...</option>
          <option value="Casa">Casa</option>
          <option value="Departamento">Departamento</option>
          <option value="Terreno">Terreno</option>
          <option value="Comercial">Comercial</option>
        </select>
      </label>
      <label>
        Estado
        <select name="estado" id="estado" required>
          <option value="venta">Venta</option>
          <option value="arriendo">Arriendo</option>
        </select>
      </label>
      <label>
        Dormitorios
        <input type="number" name="dormitorios" id="dormitorios" placeholder="3" min="0" required>
      </label>
      <label>
        Ba√±os
        <input type="number" name="ba√±os" id="ba√±os" placeholder="2" min="0" required>
      </label>
      <label>
        √Årea (m¬≤)
        <input type="number" name="area" id="area" placeholder="75" min="0" required>
      </label>
      <label>
        Descripci√≥n
        <textarea name="descripcion" id="descripcion" rows="3" placeholder="Detalle breve"></textarea>
      </label>
      <label>
        Imagen
        <input type="file" name="imagenFile" id="imagenFile" accept="image/jpeg,image/jpg" required>
        <small>Puedes arrastrar o seleccionar un archivo .jpg</small>
      </label>
      <label>
        Coordenadas (lat,lng)
        <input type="text" name="coordenadas" id="coordenadas" placeholder="-33.4489,-70.6693" required>
      </label>
      <label>
        Activo
        <select name="activo" id="activo">
          <option value="true" selected>S√≠</option>
          <option value="false">No</option>
        </select>
      </label>
      <button type="submit" id="propSubmit">Guardar</button>
      <div class="helper">Tambi√©n puedes hacer clic en el mapa para llenar las coordenadas.</div>
      <div id="propMessage"></div>
    </form>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const userBox = document.getElementById('userBox');
    const propForm = document.getElementById('propForm');
    const propMessage = document.getElementById('propMessage');
    const propSubmit = document.getElementById('propSubmit');
    const propList = document.getElementById('propList');
    const reloadBtn = document.getElementById('reloadBtn');
    const coordsInput = document.getElementById('coordenadas');

    function mostrarUsuario() {
      try {
        const guardado = localStorage.getItem('usuarioActual');
        if (!guardado) return;
        const usuario = JSON.parse(guardado);
        const nombre = [usuario.nombre, usuario.apellido].filter(Boolean).join(' ');
        userBox.textContent = nombre || usuario.email || 'Usuario conectado';
      } catch (error) {
        console.warn('No se pudo leer el usuario almacenado', error);
      }
    }

    function formatearCLP(valor) {
      const numero = Number(valor) || 0;
      return numero.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
    }

    const map = L.map('map').setView([-33.45, -70.66], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const propiedadesLayer = L.layerGroup().addTo(map);
    const marcadorTemporal = L.layerGroup().addTo(map);

    map.on('click', (event) => {
      const { lat, lng } = event.latlng;
      coordsInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      marcadorTemporal.clearLayers();
      L.marker([lat, lng], { opacity: 0.7 }).addTo(marcadorTemporal);
    });

    reloadBtn.addEventListener('click', cargarPropiedades);

    async function cargarPropiedades() {
      try {
        propiedadesLayer.clearLayers();
        propList.innerHTML = '<li>Cargando propiedades...</li>';
        const response = await fetch('/api/propiedades');
        if (!response.ok) throw new Error('No fue posible obtener propiedades');
        const propiedades = await response.json();
        dibujarPropiedades(propiedades);
      } catch (error) {
        console.error(error);
        propList.innerHTML = '<li>Error al cargar propiedades.</li>';
      }
    }

    function dibujarPropiedades(propiedades) {
      if (!propiedades.length) {
        propList.innerHTML = '<li>No hay propiedades cargadas.</li>';
        return;
      }

      propList.innerHTML = '';
      const bounds = [];

      propiedades.forEach((prop) => {
        const coords = (prop.coordenadas || '').split(',').map((v) => Number(v.trim()));
        const banos = prop['ba√±os'] ?? prop.banos ?? 0;
        if (coords.length === 2 && coords.every((n) => Number.isFinite(n))) {
          const marker = L.marker(coords).addTo(propiedadesLayer);
          marker.bindPopup(`
            <strong>${prop.nombre || 'Propiedad sin nombre'}</strong><br>
            ${formatearCLP(prop.precio)}<br>
            ${prop.localizacion || 'Sin localizaci√≥n'}
          `);
          bounds.push(coords);
        }

        const item = document.createElement('li');
        item.innerHTML = `
          <strong>${prop.nombre || 'Propiedad sin nombre'}</strong>
          <div>${formatearCLP(prop.precio)} ¬∑ ${prop.tipo || ''} ¬∑ ${prop.estado || ''}</div>
          <div>${prop.dormitorios || 0} dorm ¬∑ ${banos || 0} ba√±os ¬∑ ${prop.area || 0} m¬≤</div>
        `;
        propList.appendChild(item);
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    // Convertir archivo a Base64
    function convertirArchivoABase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const base64 = reader.result.split(",")[1]; 
          resolve(base64);
        };
        reader.onerror = (error) => reject(error);
      });
    }

    propForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      propMessage.textContent = '';
      propMessage.classList.remove('error', 'success');

      const datos = new FormData(propForm);
      const archivoImagen = document.getElementById('imagenFile').files[0];
      
      if (!archivoImagen) {
        propMessage.textContent = 'Debes seleccionar una imagen en formato JPG.';
        propMessage.classList.add('error');
        return;
      }

      const imagenBase64 = await convertirArchivoABase64(archivoImagen);

      const payload = {
        nombre: datos.get('nombre')?.trim(),
        precio: Number(datos.get('precio')),
        localizacion: datos.get('localizacion')?.trim(),
        tipo: datos.get('tipo')?.trim(),
        estado: datos.get('estado')?.trim(),
        dormitorios: Number(datos.get('dormitorios')),
        ba√±os: Number(datos.get('ba√±os')),
        area: Number(datos.get('area')),
        descripcion: datos.get('descripcion')?.trim(),
        img: imagenBase64, 
        coordenadas: datos.get('coordenadas')?.trim(),
        propietario: '',
        activo: datos.get('activo') !== 'false'
      };

      const obligatorios = ['nombre', 'precio', 'localizacion', 'tipo', 'estado', 'dormitorios', 'ba√±os', 'area', 'coordenadas'];
      const faltantes = obligatorios.filter((campo) => {
        if (['precio', 'dormitorios', 'ba√±os', 'area'].includes(campo)) {
          return !Number.isFinite(payload[campo]);
        }
        return !payload[campo];
      });

      if (faltantes.length) {
        propMessage.textContent = 'Completa todos los campos obligatorios.';
        propMessage.classList.add('error');
        return;
      }

      propSubmit.disabled = true;
      try {
        const response = await fetch('/api/propiedades', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const resultado = await response.json();
        if (!response.ok) throw new Error(resultado.error || 'No se pudo guardar la propiedad');
        propMessage.textContent = resultado.message || 'Propiedad agregada correctamente.';
        propMessage.classList.add('success');
        propForm.reset();
        marcadorTemporal.clearLayers();
        cargarPropiedades();
      } catch (error) {
        console.error(error);
        propMessage.textContent = error.message || 'No se pudo guardar la propiedad.';
        propMessage.classList.add('error');
      } finally {
        propSubmit.disabled = false;
      }
    });

    // Funciones para abrir/cerrar el panel flotante
    document.querySelector('[data-target="formPanel"]').addEventListener('click', () => {
      document.getElementById('formPanel').classList.add('active');
    });

    function cerrarForm() {
      document.getElementById('formPanel').classList.remove('active');
    }

    mostrarUsuario();
    cargarPropiedades();
  </script>
</body>
</html>
