<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/loader.css') }}">
</head>
<body>
  {% include '_loader.html' %}
  <header class="topbar">
    <div class="brand">
      <span class="logo">üõ†Ô∏è</span>
      <div>
        <h1>Panel de Administraci√≥n</h1>
        <p>Gestiona usuarios, propiedades y estad√≠sticas de ViviendaDigital.</p>
      </div>
    </div>
    <nav class="top-actions">
      <a href="{{ url_for('logout') }}" class="btn ghost">Cerrar sesi√≥n</a>
    </nav>
  </header>

  <main class="dashboard">
    <section class="card">
      <h2>Gesti√≥n de propiedades</h2>
      

      <div class="table-wrapper">
        <table class="crud-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Localizaci√≥n</th>
              <th>Propietario</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="propTableBody">
            {% for p in propiedades %}  
            <tr>
              <td>{{ p["id"] }}</td>
              <td>{{ p["nombre"] }}</td>
              <td>${{ p["precio"] }}</td>
              <td>{{ p["localizacion"] }}</td>
              <td>{{ p["propietario_nombre"] }}</td>
              <td>
                <button class="btn btn-edit-prop" data-id="{{ p['id'] }}">Editar</button>
                <button class="btn btn-delete-prop" data-id="{{ p['id'] }}">Eliminar</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    <section class="card">
      <h2>Gesti√≥n de usuarios</h2>
     

      <div class="table-wrapper">
        <table class="crud-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            {% for u in usuarios %}  
            <tr>
              <td>{{ u["id"] }}</td>
              <td>{{ u["nombre"] }} {{ u["apellido"] }}</td>
              <td>{{ u["email"] }}</td>
              <td>{{ u["rol_legible"] }}</td>
              <td>
                <button class="btn btn-edit-user" data-id="{{ u['id'] }}">Editar</button>
                <button class="btn btn-delete-user" data-id="{{ u['id'] }}">Eliminar</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main> 
  <div id="formPanel" class="modal hidden">
    <div class="modal-content">
      <form id="propForm">
        <input type="hidden" id="propId">
        <h2 id="formTitle">Editar propiedad</h2>

        <label>Nombre
          <input type="text" id="nombre" required>
        </label>
        <label>Precio (CLP)
          <input type="number" id="precio" required>
        </label>
        <label>Localizaci√≥n
          <input type="text" id="localizacion" required>
        </label>
        <label>Tipo
          <select id="tipo" required>
            <option value="Casa">Casa</option>
            <option value="Departamento">Departamento</option>
            <option value="Terreno">Terreno</option>
            <option value="Comercial">Comercial</option>
          </select>
        </label>
        <label>Estado
          <select id="estado" required>
            <option value="venta">Venta</option>
            <option value="arriendo">Arriendo</option>
          </select>
        </label>
        <label>Dormitorios
          <input type="number" id="dormitorios" min="0" required>
        </label>
        <label>Ba√±os
          <input type="number" id="ba√±os" min="0" required>
        </label>
        <label>√Årea (m¬≤)
          <input type="number" id="area" min="0" required>
        </label>
        <label>Descripci√≥n
          <textarea id="descripcion"></textarea>
        </label>
        <label>Imagen
          <input type="file" id="imagenFile" accept="image/jpeg,image/jpg">
          <small id="imagenActualInfo"></small>
        </label>
        <label>Coordenadas
          <input type="text" id="coordenadas" required>
        </label>
        <label>Activo
          <select id="activo">
            <option value="true">S√≠</option>
            <option value="false">No</option>
          </select>
        </label>

        <div class="form-actions">
          <button type="submit" class="btn">üíæ Guardar cambios</button>
          <button type="button" id="closeModalBtn" class="btn ghost">Cerrar</button>
        </div>
        <div id="propMessage"></div>
      </form>
    </div>
  </div>

<div id="userFormPanel" class="modal hidden">
  <div class="modal-content">
    <form id="userForm">
  <input type="hidden" id="userId">
  <h2>Editar usuario</h2>

  <label>Nombre
    <input type="text" id="userNombre" required>
  </label>

  <label>Apellido
    <input type="text" id="userApellido" required>
  </label>

  <label>Email
    <input type="email" id="userEmail" required>
  </label>

  <label>Tel√©fono
    <input type="text" id="userTelefono" placeholder="+56 9 XXXX XXXX">
  </label>

  <label>RUT
    <input type="text" id="userRut" placeholder="12.345.678-9">
  </label>

  <label>Direcci√≥n
    <input type="text" id="userDireccion">
  </label>

  <label>Ciudad
    <input type="text" id="userCiudad">
  </label>

  <label>Tipo de usuario
    <select id="userTipo">
      <option value="admin">Administrador</option>
      <option value="vendedor">Vendedor</option>
      <option value="comprador">Comprador</option>
    </select>
  </label>

  <div class="form-actions">
    <button type="submit" class="btn">üíæ Guardar cambios</button>
    <button type="button" id="closeUserModalBtn" class="btn ghost">Cerrar</button>
  </div>

  <div id="userMessage"></div>
</form>
  </div>
</div>

<div id="confirmModal" class="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="confirmModalTitle" aria-describedby="confirmModalMessage" tabindex="-1">
  <div class="confirm-modal__panel" role="document">
    <span class="confirm-modal__icon" id="confirmModalIcon" aria-hidden="true">‚ùî</span>
    <h2 class="confirm-modal__title" id="confirmModalTitle">¬øEst√°s seguro?</h2>
    <p class="confirm-modal__message" id="confirmModalMessage">Confirma la acci√≥n solicitada.</p>
    <div class="confirm-modal__actions">
      <button type="button" class="btn ghost confirm-modal__cancel" id="confirmModalCancel">Cancelar</button>
      <button type="button" class="btn danger confirm-modal__accept" id="confirmModalAccept">Aceptar</button>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/loader.js') }}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
// ======== PROPIEDADES ======== //
const formPanel = document.getElementById("formPanel");
const closeModalBtn = document.getElementById("closeModalBtn");
const propForm = document.getElementById("propForm");
const propId = document.getElementById("propId");
const propMessage = document.getElementById("propMessage");
const imagenInput = document.getElementById("imagenFile");
const imagenActualInfo = document.getElementById("imagenActualInfo");
let imagenBase64Temporal = null;
const searchPropInput = document.getElementById("searchId");
const propRows = Array.from(document.querySelectorAll("#propTableBody tr"));
const confirmModal = document.getElementById("confirmModal");
const confirmTitle = document.getElementById("confirmModalTitle");
const confirmMessage = document.getElementById("confirmModalMessage");
const confirmAccept = document.getElementById("confirmModalAccept");
const confirmCancel = document.getElementById("confirmModalCancel");
const confirmIcon = document.getElementById("confirmModalIcon");
const hasCustomConfirm = Boolean(
  confirmModal &&
  confirmTitle &&
  confirmMessage &&
  confirmAccept &&
  confirmCancel &&
  confirmIcon
);
let confirmResolver = null;
let lastFocusedElement = null;
const FEEDBACK_CLASSES = ["is-error", "is-success"];

function setFeedback(node, message, type) {
  if (!node) return;
  node.textContent = message || "";
  FEEDBACK_CLASSES.forEach(cls => node.classList.remove(cls));
  if (!message) return;
  if (type === "success") node.classList.add("is-success");
  if (type === "error") node.classList.add("is-error");
}

function closeConfirm(result) {
  if (!hasCustomConfirm) {
    const resolver = confirmResolver;
    confirmResolver = null;
    if (resolver) resolver(result);
    return;
  }
  confirmModal.classList.remove("is-visible");
  confirmModal.setAttribute("aria-hidden", "true");
  confirmModal.removeAttribute("data-tone");
  const resolver = confirmResolver;
  confirmResolver = null;
  if (lastFocusedElement && typeof lastFocusedElement.focus === "function") {
    lastFocusedElement.focus({ preventScroll: true });
  }
  lastFocusedElement = null;
  if (resolver) resolver(result);
}

function confirmAction(options = {}) {
  if (!hasCustomConfirm) {
    confirmResolver = null;
    return Promise.resolve(window.confirm(options.message || "¬øEst√°s seguro?"));
  }
  const {
    title = "¬øEst√°s seguro?",
    message = "Confirma la acci√≥n solicitada.",
    confirmLabel = "Aceptar",
    cancelLabel = "Cancelar",
    tone = "info",
    icon = "‚ùî"
  } = options;

  confirmTitle.textContent = title;
  confirmMessage.textContent = message;
  confirmAccept.textContent = confirmLabel;
  confirmCancel.textContent = cancelLabel;
  confirmIcon.textContent = icon || "‚ùî";
  confirmAccept.classList.toggle("danger", tone === "danger");
  confirmModal.dataset.tone = tone;
  confirmModal.setAttribute("aria-hidden", "false");
  confirmModal.classList.add("is-visible");
  lastFocusedElement = document.activeElement;
  window.setTimeout(() => {
    confirmAccept.focus({ preventScroll: true });
  }, 50);

  return new Promise(resolve => {
    confirmResolver = resolve;
  });
}

if (hasCustomConfirm) {
  confirmAccept.addEventListener("click", () => closeConfirm(true));
  confirmCancel.addEventListener("click", () => closeConfirm(false));
  confirmModal.addEventListener("click", (event) => {
    if (event.target === confirmModal) {
      closeConfirm(false);
    }
  });

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && confirmModal.classList.contains("is-visible")) {
      event.preventDefault();
      closeConfirm(false);
    }
  });
}

closeModalBtn.addEventListener("click", () => formPanel.classList.add("hidden"));

function convertirArchivoABase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = (error) => reject(error);
  });
}

document.querySelectorAll(".btn-edit-prop").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;
    try {
      const propiedades = await Loader.wrap(async () => {
        const res = await fetch(`/api/propiedades`);
        if (!res.ok) {
          throw new Error("No se pudo obtener propiedades");
        }
        return res.json();
      }, "Cargando propiedades...");

      const prop = propiedades.find(p => p.id == id);
      if (!prop) return;

      propId.value = prop.id;
      document.getElementById("nombre").value = prop.nombre;
      document.getElementById("precio").value = prop.precio;
      document.getElementById("localizacion").value = prop.localizacion;
      document.getElementById("tipo").value = prop.tipo;
      document.getElementById("estado").value = prop.estado;
      document.getElementById("dormitorios").value = prop.dormitorios;
      document.getElementById("ba√±os").value = prop["ba√±os"] || prop.banos;
      document.getElementById("area").value = prop.area;
      document.getElementById("descripcion").value = prop.descripcion;
      document.getElementById("coordenadas").value = prop.coordenadas;
      document.getElementById("activo").value = prop.activo ? "true" : "false";

      imagenBase64Temporal = prop.img || null;
      imagenActualInfo.textContent = imagenBase64Temporal
        ? "Se conservar√° la imagen actual a menos que subas una nueva."
        : "No hay imagen guardada. Debes subir una nueva.";

      formPanel.classList.remove("hidden");
    } catch (error) {
      console.error("Error al cargar propiedad:", error);
      alert("No fue posible cargar la propiedad seleccionada.");
    }
  });
});


propForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (imagenInput.files.length > 0)
    imagenBase64Temporal = await convertirArchivoABase64(imagenInput.files[0]);

  const payload = {
    nombre: document.getElementById("nombre").value,
    precio: Number(document.getElementById("precio").value),
    localizacion: document.getElementById("localizacion").value,
    tipo: document.getElementById("tipo").value,
    estado: document.getElementById("estado").value,
    dormitorios: Number(document.getElementById("dormitorios").value),
    ba√±os: Number(document.getElementById("ba√±os").value),
    area: Number(document.getElementById("area").value),
    descripcion: document.getElementById("descripcion").value,
    coordenadas: document.getElementById("coordenadas").value,
    activo: document.getElementById("activo").value === "true",
    img: imagenBase64Temporal
  };

  try {
    const { res, data } = await Loader.wrap(async () => {
      const res = await fetch(`/api/propiedades/editar/${propId.value}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }, "Guardando cambios de la propiedad...");

    const message = data.message || data.error || "Error";
    setFeedback(propMessage, message, res.ok ? "success" : "error");
    if (res.ok) location.reload();
  } catch (error) {
    console.error("Error al actualizar propiedad:", error);
    setFeedback(propMessage, "Error al actualizar la propiedad.", "error");
  }
});


document.querySelectorAll(".btn-delete-prop").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;
    const accepted = await confirmAction({
      title: "Eliminar propiedad",
      message: "¬øQuieres eliminar esta propiedad? Esta acci√≥n no se puede deshacer.",
      confirmLabel: "Eliminar",
      cancelLabel: "Cancelar",
      tone: "danger",
      icon: "üóëÔ∏è"
    });
    if (!accepted) return;
    try {
      const { res, data } = await Loader.wrap(async () => {
        const res = await fetch(`/api/propiedades/eliminar/${id}`, { method: "POST" });
        const data = await res.json().catch(() => ({}));
        return { res, data };
      }, "Eliminando propiedad seleccionada...");

      const message = data.message || data.error || "Propiedad eliminada";
      setFeedback(propMessage, message, res.ok ? "success" : "error");
      if (res.ok) location.reload();
    } catch (error) {
      console.error("Error al eliminar propiedad:", error);
      setFeedback(propMessage, "No fue posible eliminar la propiedad.", "error");
    }
  });
});

function filtrarPropiedades() {
  if (!searchPropInput) return;
  const query = (searchPropInput.value || "").trim();
  propRows.forEach(row => {
    const idCell = row.querySelector("td");
    const coincide = !query || (idCell && idCell.textContent.trim().includes(query));
    row.style.display = coincide ? "" : "none";
  });
}

if (searchPropInput) {
  searchPropInput.addEventListener("input", filtrarPropiedades);
}


  // ======== USUARIOS ======== //
  const userFormPanel = document.getElementById("userFormPanel");
  const userForm = document.getElementById("userForm");
  const closeUserModalBtn = document.getElementById("closeUserModalBtn");
  const userMessage = document.getElementById("userMessage");
  let editandoUsuarioId = null;

  closeUserModalBtn.addEventListener("click", () => userFormPanel.classList.add("hidden"));

  // Funci√≥n para agregar event listeners a los botones de editar usuarios
  function addEditUserListeners() {
    document.querySelectorAll("button.btn-edit-user").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        try {
          const usuarios = await Loader.wrap(async () => {
            const res = await fetch("/api/usuarios");
            if (!res.ok) {
              throw new Error("No se pudo obtener usuarios");
            }
            return res.json();
          }, "Cargando informaci√≥n del usuario...");
          const user = usuarios.find(u => u.id == id);
          if (!user) return;
          editandoUsuarioId = user.id;

          document.getElementById("userId").value = user.id;
          document.getElementById("userNombre").value = user.nombre || "";
          document.getElementById("userApellido").value = user.apellido || "";
          document.getElementById("userEmail").value = user.email || "";
          document.getElementById("userTelefono").value = user.telefono || "";
          document.getElementById("userRut").value = user.rut || "";
          document.getElementById("userDireccion").value = user.direccion || "";
          document.getElementById("userCiudad").value = user.ciudad || "";
          const tipoSeleccionado = (user.rol_legible || "").toLowerCase();
          document.getElementById("userTipo").value = tipoSeleccionado;

          userFormPanel.classList.remove("hidden");
        } catch (error) {
          console.error("Error al cargar usuario:", error);
          alert("Error al cargar los datos del usuario");
        }
      });
    });
  }

  // Funci√≥n para agregar event listeners a los botones de eliminar usuarios
  function addDeleteUserListeners() {
    document.querySelectorAll(".btn-delete-user").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        const accepted = await confirmAction({
          title: "Eliminar usuario",
          message: "¬øQuieres eliminar este usuario? Si tiene propiedades asociadas no se podr√° eliminar.",
          confirmLabel: "Eliminar",
          cancelLabel: "Cancelar",
          tone: "danger",
          icon: "‚ö†Ô∏è"
        });
        if (!accepted) return;
        try {
          const { res, data } = await Loader.wrap(async () => {
            const res = await fetch(`/api/usuarios/${id}`, { method: "DELETE" });
            const data = await res.json().catch(() => ({}));
            return { res, data };
          }, "Eliminando usuario...");
          const message = data.message || data.error || "Usuario eliminado";
          setFeedback(userMessage, message, res.ok ? "success" : "error");
          if (res.ok) location.reload();
        } catch (error) {
          console.error("Error al eliminar usuario:", error);
          setFeedback(userMessage, "Error al eliminar el usuario.", "error");
        }
      });
    });
  }

  // Agregar listeners al cargar la p√°gina
  addEditUserListeners();
  addDeleteUserListeners();

  userForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      nombre: document.getElementById("userNombre").value,
      apellido: document.getElementById("userApellido").value,
      email: document.getElementById("userEmail").value,
      telefono: document.getElementById("userTelefono")?.value || "",
      rut: document.getElementById("userRut")?.value || "",
      direccion: document.getElementById("userDireccion")?.value || "",
      ciudad: document.getElementById("userCiudad")?.value || "",
      tipo_usuario: document.getElementById("userTipo").value,
    };

  try {
    const { res, data } = await Loader.wrap(async () => {
      const res = await fetch(`/api/usuarios/${editandoUsuarioId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }, "Guardando cambios del usuario...");

    const message = data.message || data.error || "Error";
    setFeedback(userMessage, message, res.ok ? "success" : "error");
    if (res.ok) location.reload();
  } catch (error) {
    console.error("Error al actualizar usuario:", error);
    setFeedback(userMessage, "Error al actualizar el usuario", "error");
  }
});

});
</script>
</body>
</html>
