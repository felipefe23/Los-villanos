<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro Comprador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/comprador_login.css') }}">
</head>
<body>
  <main class="login-page">
    <section class="login-card" aria-label="Registro Comprador">
      <header class="login-head">
        <a class="back" href="{{ url_for('comprador_login_view') }}">‚Üê Volver</a>
        <div class="role-badge" aria-hidden="true">üîç</div>
      </header>

      <h1 class="title">Crear cuenta</h1>
      <span class="role-pill">Comprador</span>

      <form class="login-form" id="registerForm" novalidate>
        <label class="field">
          <span>Nombre</span>
          <input type="text" id="reg_nombre" placeholder="Tu nombre" required>
        </label>

        <label class="field">
          <span>Apellido</span>
          <input type="text" id="reg_apellido" placeholder="Tu apellido" required>
        </label>

        <label class="field">
          <span>Correo electr√≥nico</span>
          <input type="email" id="reg_email" placeholder="tu@email.com" required>
        </label>

        <label class="field">
          <span>Tel√©fono</span>
          <input type="text" id="reg_telefono" placeholder="+56 9 1234 5678" required>
        </label>

        <label class="field">
          <span>RUT</span>
          <input type="text" id="reg_rut" placeholder="12345678-9" required>
        </label>

        <label class="field">
          <span>Direcci√≥n</span>
          <input type="text" id="reg_direccion" placeholder="Calle y n√∫mero" required>
        </label>

        <label class="field">
          <span>Ciudad</span>
          <input type="text" id="reg_ciudad" placeholder="Ciudad" required>
        </label>

        <label class="field">
          <span>Contrase√±a</span>
          <input type="password" id="reg_password" placeholder="********" required>
        </label>

        <input type="hidden" id="reg_tipo_usuario" value="comprador">

        <button type="submit" class="btn-primary">Registrarme</button>
        <p class="form-msg" id="registroMsg" role="alert" aria-live="polite"></p>
      </form>

      <p class="hint">¬øYa tienes cuenta? <a href="{{ url_for('comprador_login_view') }}">Inicia sesi√≥n aqu√≠</a></p>
    </section>
  </main>

  <script>
    const form = document.getElementById('registerForm');
    const mensaje = document.getElementById('registroMsg');

    function validarEmail(email) {
      return /^[^@]{2,}@[^@]+\.[^@]+$/.test(email);
    }
    function validarPassword(password) {
      return /^(?=.*\d).{8,}$/.test(password);
    }

    function limpiarCampos() {
      ['reg_nombre','reg_apellido','reg_email','reg_telefono','reg_rut','reg_direccion','reg_ciudad','reg_password']
        .forEach(id => {
          const campo = document.getElementById(id);
          if (campo) campo.value = '';
        });
    }

    form.addEventListener('submit', async (evento) => {
      evento.preventDefault();
      const datos = {
        nombre: document.getElementById('reg_nombre').value.trim(),
        apellido: document.getElementById('reg_apellido').value.trim(),
        email: document.getElementById('reg_email').value.trim(),
        telefono: document.getElementById('reg_telefono').value.trim(),
        rut: document.getElementById('reg_rut').value.trim(),
        direccion: document.getElementById('reg_direccion').value.trim(),
        ciudad: document.getElementById('reg_ciudad').value.trim(),
        password: document.getElementById('reg_password').value.trim(),
        tipo_usuario: document.getElementById('reg_tipo_usuario').value.trim()
      };

      mensaje.style.color = '#ef4444';
      mensaje.textContent = '';

      if (datos.nombre.length < 2) {
        mensaje.textContent = 'Agrega un nombre v√°lido (m√≠nimo 2 caracteres).';
        return;
      }
      if (datos.apellido.length < 2) {
        mensaje.textContent = 'Agrega un apellido v√°lido (m√≠nimo 2 caracteres).';
        return;
      }
      if (!validarEmail(datos.email)) {
        mensaje.textContent = 'Correo inv√°lido (m√≠nimo 2 caracteres antes del @).';
        return;
      }
      if (!datos.telefono) {
        mensaje.textContent = 'Indica un tel√©fono de contacto.';
        return;
      }
      if (!datos.rut) {
        mensaje.textContent = 'Ingresa un RUT en formato 12345678-9.';
        return;
      }
      if (datos.direccion.length < 5) {
        mensaje.textContent = 'La direcci√≥n debe contener al menos 5 caracteres.';
        return;
      }
      if (datos.ciudad.length < 2) {
        mensaje.textContent = 'Indica la ciudad donde resides.';
        return;
      }
      if (!validarPassword(datos.password)) {
        mensaje.textContent = 'Contrase√±a debe tener al menos 8 caracteres y 1 n√∫mero.';
        return;
      }

      mensaje.style.color = '#6b7280';
      mensaje.textContent = 'Creando tu cuenta...';

      try {
        const respuesta = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(datos)
        });
        const resultado = await respuesta.json();

        if (!respuesta.ok) {
          mensaje.style.color = '#ef4444';
          mensaje.textContent = `‚ùå ${resultado.error || 'No fue posible crear la cuenta.'}`;
          return;
        }

        mensaje.style.color = '#16a34a';
        mensaje.textContent = `‚úÖ ${resultado.message}`;
        limpiarCampos();

        setTimeout(() => {
          window.location.href = '{{ url_for('comprador_login_view') }}';
        }, 1200);
      } catch (error) {
        mensaje.style.color = '#ef4444';
        mensaje.textContent = '‚ùå Error de conexi√≥n con el servidor.';
      }
    });
  </script>
</body>
</html>
