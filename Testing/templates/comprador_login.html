<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login Comprador</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/comprador_login.css') }}?v=1">
</head>
<body>
  <main class="login-page">
    <section class="login-card" aria-label="Iniciar Sesión Comprador">
      <header class="login-head">
        <a class="back" href="{{ url_for('landing') }}">← Volver</a>
        <div class="role-badge" aria-hidden="true">🔍</div>
      </header>

      <h1 class="title">Iniciar Sesión</h1>
      <span class="role-pill">Comprador</span>

      <form id="loginForm" class="login-form" novalidate>
    
        <label class="field">
          <span>Correo Electrónico</span>
          <input type="email" name="email" placeholder="tu@email.com" required>
        </label>

        <label class="field">
          <span>Contraseña</span>
          <div class="password-wrap">
            <input type="password" name="password" id="password" placeholder="********" required>
            <button type="button" id="togglePass" aria-label="Mostrar u ocultar contraseña">👁️</button>
          </div>
        </label>

        <button type="submit" class="btn-primary">Iniciar Sesión</button>
        <p class="form-msg" id="formMsg" role="alert" aria-live="polite"></p>
      </form>

      <p class="hint">¿No tienes cuenta? <a href="{{ url_for('comprador_register_view') }}">Crea tu cuenta aquí</a></p>
    </section>
  </main>

  <script>
    const passwordInput = document.getElementById('password');
    const togglePassBtn = document.getElementById('togglePass');
    const form = document.getElementById('loginForm');
    const mensajeForm = document.getElementById('formMsg');

    togglePassBtn.addEventListener('click', () => {
      const esOculta = passwordInput.getAttribute('type') === 'password';
      passwordInput.setAttribute('type', esOculta ? 'text' : 'password');
      togglePassBtn.textContent = esOculta ? '🙈' : '👁️';
    });

    function validarEmail(email) {
      return /^[^@]{2,}@[^@]+\.[^@]+$/.test(email);
    }

    function validarPassword(password) {
      return /^(?=.*\d).{8,}$/.test(password);
    }

    async function loginComprador(email, password) {
      try {
        const respuesta = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const resultado = await respuesta.json();
        if (!respuesta.ok) {
          mensajeForm.style.color = '#ef4444';
          mensajeForm.textContent = `❌ ${resultado.error || 'Error al iniciar sesión.'}`;
          return;
        }

        const usuario = resultado.user || null;
        if (usuario) {
          localStorage.setItem('usuarioActual', JSON.stringify(usuario));
        }

        mensajeForm.style.color = '#16a34a';
        mensajeForm.textContent = `✅ ${resultado.message}`;

        setTimeout(() => {
          window.location.href = '/comprador';
        }, 800);
      } catch (error) {
        mensajeForm.style.color = '#ef4444';
        mensajeForm.textContent = '❌ Error de conexión con el servidor.';
      }
    }

    form.addEventListener('submit', (evento) => {
      evento.preventDefault();
      const email = form.email.value.trim();
      const password = form.password.value.trim();

      if (!validarEmail(email)) {
        mensajeForm.style.color = '#ef4444';
        mensajeForm.textContent = 'Correo inválido (mínimo 2 caracteres antes del @).';
        return;
      }

      if (!validarPassword(password)) {
        mensajeForm.style.color = '#ef4444';
        mensajeForm.textContent = 'Contraseña inválida (mínimo 8 caracteres y un número).';
        return;
      }

      mensajeForm.style.color = '#6b7280';
      mensajeForm.textContent = 'Procesando...';
      loginComprador(email, password);
    });
  </script>
</body>
</html>
