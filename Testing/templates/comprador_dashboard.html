<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Comprador</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/comprador_dashboard.css') }}">
</head>
<body>
    <header class="encabezado">
        <div class="contenedor">
            <div class="barra-superior">
                <a class="btn-volver" href="{{ url_for('landing') }}">← Volver</a>
                <div class="user-widget" id="userWidget" hidden>
                    <button class="user-widget__trigger" id="userTrigger" aria-label="Mostrar datos del usuario" aria-expanded="false">
                        <span class="user-widget__initials" id="userInitials">US</span>
                        <span class="user-widget__name" id="userShortName"></span>
                    </button>
                    <div class="user-widget__panel" id="userPanel" role="dialog" aria-modal="false">
                        <h2>Datos del usuario</h2>
                        <ul>
                            <li><span>Nombre completo:</span> <strong id="userNombre"></strong></li>
                            <li><span>Correo:</span> <strong id="userEmail"></strong></li>
                            <li><span>Teléfono:</span> <strong id="userTelefono"></strong></li>
                            <li><span>RUT:</span> <strong id="userRut"></strong></li>
                            <li><span>Dirección:</span> <strong id="userDireccion"></strong></li>
                            <li><span>Ciudad:</span> <strong id="userCiudad"></strong></li>
                            <li><span>Tipo de usuario:</span> <strong id="userTipo"></strong></li>
                            <li><span>Registrado el:</span> <strong id="userFecha"></strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            <h1>Explora propiedades en venta</h1>
            <p>Elige la vista que prefieras para comparar precios, ubicaciones y detalles relevantes.</p>
        </div>
    </header>

    <main class="contenedor principal">
        <div class="selector-vistas" role="tablist" aria-label="Selector de vista">
            <button class="btn-opcion activa" data-target="mosaico" role="tab" aria-selected="true">Ver mosaico</button>
            <button class="btn-opcion" data-target="mapa" role="tab" aria-selected="false">Ver mapa</button>
        </div>

        <section id="vista-mosaico" class="vista activa" role="tabpanel" aria-label="Mosaico de propiedades">
            {% if propiedades %}
                <div class="mosaico">
                    {% for propiedad in propiedades %}
                        {% set precio = propiedad.get('precio') or 0 %}
                        <article class="tarjeta">
                            <div class="imagen" aria-hidden="true">
                                {% if propiedad.get('img') %}
                                    <img src="data:image/jpeg;base64,{{ propiedad.get('img') }}" alt="Imagen de {{ propiedad.get('nombre', 'Propiedad sin nombre') }}">
                                {% else %}
                                    <div class="imagen-placeholder">Sin imagen</div>
                                {% endif %}
                            </div>
                            <div class="contenido">
                                <h2>{{ propiedad.get('nombre', 'Propiedad sin nombre') }}</h2>
                                <p class="precio">${{ '{:,}'.format(precio|int).replace(',', '.') }}</p>
                                <p class="descripcion">{{ propiedad.get('descripcion', 'Sin descripción disponible') }}</p>
                                <ul class="detalles">
                                    <li><span>Ubicación:</span> {{ propiedad.get('localizacion', 'No indicada') }}</li>
                                    <li><span>Dormitorios:</span> {{ propiedad.get('dormitorios', 'N/D') }}</li>
                                    <li><span>Baños:</span> {{ propiedad.get('baños', 'N/D') }}</li>
                                    <li><span>Área:</span> {{ propiedad.get('area', 'N/D') }} m²</li>
                                    <li><span>Tipo:</span> {{ propiedad.get('tipo', 'No especificado') }}</li>
                                </ul>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="sin-resultados">
                    <h2>No hay propiedades publicadas en venta por ahora.</h2>
                    <p>Cuando se agreguen nuevas viviendas aparecerán tanto en el mosaico como en el mapa.</p>
                </div>
            {% endif %}
        </section>

        <section id="vista-mapa" class="vista" role="tabpanel" aria-label="Mapa de propiedades" hidden>
            <div id="map"></div>
            <p class="nota-mapa">Arrastra o acerca el mapa para explorar distintas zonas.</p>
        </section>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const widget = document.getElementById('userWidget');
        const trigger = document.getElementById('userTrigger');
        const panel = document.getElementById('userPanel');
        const camposUsuario = {
            nombre: document.getElementById('userNombre'),
            email: document.getElementById('userEmail'),
            telefono: document.getElementById('userTelefono'),
            rut: document.getElementById('userRut'),
            direccion: document.getElementById('userDireccion'),
            ciudad: document.getElementById('userCiudad'),
            tipo: document.getElementById('userTipo'),
            fecha: document.getElementById('userFecha'),
            initials: document.getElementById('userInitials'),
            shortName: document.getElementById('userShortName')
        };

        function obtenerUsuarioActual() {
            try {
                const guardado = localStorage.getItem('usuarioActual');
                if (!guardado) return null;
                return JSON.parse(guardado);
            } catch (error) {
                console.warn('No fue posible leer los datos de usuario almacenados', error);
                return null;
            }
        }

        function formatearIniciales(nombre, apellido, email) {
            const letras = [];
            if (nombre) letras.push(nombre.trim()[0]);
            if (apellido) letras.push(apellido.trim()[0]);
            if (letras.length === 0 && email) letras.push(email.trim()[0]);
            return letras.join('').toUpperCase().slice(0, 2) || 'US';
        }

        function formatearNombreCorto(nombre, email) {
            if (nombre) {
                return nombre.split(' ')[0];
            }
            if (email) {
                return email.split('@')[0];
            }
            return 'Usuario';
        }

        function formatearTipo(tipo) {
            if (!tipo) return 'Sin especificar';
            const mapa = { vendedor: 'Vendedor', comprador: 'Comprador' };
            return mapa[tipo.toLowerCase()] || tipo;
        }

        function formatearFecha(fechaIso) {
            if (!fechaIso) return 'Sin dato';
            const fecha = new Date(fechaIso);
            if (Number.isNaN(fecha.getTime())) return 'Sin dato';
            return new Intl.DateTimeFormat('es-CL', { dateStyle: 'long' }).format(fecha);
        }

        function poblarWidget(usuario) {
            if (!widget || !usuario) {
                return;
            }
            widget.hidden = false;
            camposUsuario.nombre.textContent = `${usuario.nombre || ''} ${usuario.apellido || ''}`.trim() || 'Sin nombre';
            camposUsuario.email.textContent = usuario.email || 'Sin correo';
            camposUsuario.telefono.textContent = usuario.telefono || 'Sin teléfono';
            camposUsuario.rut.textContent = usuario.rut || 'Sin RUT';
            camposUsuario.direccion.textContent = usuario.direccion || 'Sin dirección';
            camposUsuario.ciudad.textContent = usuario.ciudad || 'Sin ciudad';
            camposUsuario.tipo.textContent = formatearTipo(usuario.tipo_usuario);
            camposUsuario.fecha.textContent = formatearFecha(usuario.fecha_registro);
            camposUsuario.initials.textContent = formatearIniciales(usuario.nombre, usuario.apellido, usuario.email);
            camposUsuario.shortName.textContent = formatearNombreCorto(usuario.nombre, usuario.email);
        }

        function cerrarPanelUsuario() {
            if (!widget) return;
            widget.classList.remove('user-widget--abierta');
            if (trigger) trigger.setAttribute('aria-expanded', 'false');
        }

        function inicializarWidgetUsuario() {
            const usuario = obtenerUsuarioActual();
            if (!usuario || !widget || !trigger || !panel) {
                if (widget) widget.hidden = true;
                return;
            }

            poblarWidget(usuario);

            trigger.addEventListener('click', () => {
                const abierta = widget.classList.toggle('user-widget--abierta');
                trigger.setAttribute('aria-expanded', abierta ? 'true' : 'false');
            });

            document.addEventListener('click', (evento) => {
                if (!widget.contains(evento.target)) {
                    cerrarPanelUsuario();
                }
            });

            document.addEventListener('keydown', (evento) => {
                if (evento.key === 'Escape') {
                    cerrarPanelUsuario();
                }
            });
        }

        inicializarWidgetUsuario();

        const botones = document.querySelectorAll('.btn-opcion');
        const vistas = {
            mosaico: document.getElementById('vista-mosaico'),
            mapa: document.getElementById('vista-mapa')
        };

        let mapaInicializado = false;
        const propiedadesVenta = {{ propiedades|tojson }};

        function activarVista(nombreVista) {
            Object.keys(vistas).forEach(vista => {
                const esActiva = vista === nombreVista;
                vistas[vista].classList.toggle('activa', esActiva);
                vistas[vista].toggleAttribute('hidden', !esActiva);
            });
            botones.forEach(boton => {
                const esActiva = boton.dataset.target === nombreVista;
                boton.classList.toggle('activa', esActiva);
                boton.setAttribute('aria-selected', esActiva ? 'true' : 'false');
            });

            if (nombreVista === 'mapa' && !mapaInicializado) {
                inicializarMapa();
                mapaInicializado = true;
            }
        }

        botones.forEach(boton => {
            boton.addEventListener('click', () => activarVista(boton.dataset.target));
        });

        function inicializarMapa() {
            if (!document.getElementById('map')) {
                return;
            }
            const mapa = L.map('map').setView([-33.45, -70.6667], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapa);

            const grupo = L.layerGroup().addTo(mapa);

            if (propiedadesVenta.length === 0) {
                return;
            }

            const bounds = [];
            propiedadesVenta.forEach(propiedad => {
                const coords = propiedad.coordenadas || '';
                const partes = coords.split(',').map(parseFloat);
                if (partes.length === 2 && !Number.isNaN(partes[0]) && !Number.isNaN(partes[1])) {
                    const marker = L.marker(partes).addTo(grupo);
                    const precio = Number(propiedad.precio) || 0;
                    marker.bindPopup(`
                        <strong>${propiedad.nombre || 'Propiedad sin nombre'}</strong><br>
                        Precio: $${precio.toLocaleString('es-CL')}<br>
                        Ubicación: ${propiedad.localizacion || 'No indicada'}<br>
                        ${propiedad.img ? `<img src="data:image/jpeg;base64,${propiedad.img}" 
                            alt="Imagen de propiedad" 
                            style="max-width:150px;max-height:100px;object-fit:cover;margin-top:4px;border:1px solid #ccc;">` : ''}
                    `);
                    bounds.push(partes);
                }
            });

            if (bounds.length > 0) {
                mapa.fitBounds(bounds, { padding: [20, 20] });
            }
        }
    </script>
</body>
</html>
