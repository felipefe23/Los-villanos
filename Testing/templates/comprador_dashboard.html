<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Comprador</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/comprador_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loader.css') }}">
</head>
<body>
    {% include '_loader.html' %}
    <header class="encabezado">
        <img src="{{ url_for('static', filename='img/logo.png') }}"
                     alt="Los Villanos"
                     class="main-logo">
        <div class="contenedor">
            <div class="barra-superior">
                <a class="btn-volver" id="main-nav-link" href="{{ url_for('landing') }}">‚Üê Cerrar sesi√≥n</a>
                <div class="user-widget" id="userWidget" hidden>
                    <button class="user-widget__trigger" id="userTrigger" aria-label="Mostrar datos del usuario" aria-expanded="false">
                        <span class="user-widget__initials" id="userInitials">US</span>
                        <span class="user-widget__name" id="userShortName"></span>
                    </button>
                    <div class="user-widget__panel" id="userPanel" role="dialog" aria-modal="false">
                        <h2>Datos del usuario</h2>
                        <ul>
                            <li><span>Nombre completo:</span> <strong id="userNombre"></strong></li>
                            <li><span>Correo:</span> <strong id="userEmail"></strong></li>
                            <li><span>Tel√©fono:</span> <strong id="userTelefono"></strong></li>
                            <li><span>RUT:</span> <strong id="userRut"></strong></li>
                            <li><span>Direcci√≥n:</span> <strong id="userDireccion"></strong></li>
                            <li><span>Ciudad:</span> <strong id="userCiudad"></strong></li>
                            
                            <li><span>Registrado el:</span> <strong id="userFecha"></strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            <h1>Explora propiedades en venta</h1>
            <p>Elige la vista que prefieras para comparar precios, ubicaciones y detalles relevantes.</p>
        </div>
    </header>

    <main class="contenedor principal">   
        </section>
        <div class="barra-herramientas">
            <div class="selector-vistas" role="tablist" aria-label="Selector de vista">
                <button class="btn-opcion activa" data-target="mosaico" role="tab" aria-selected="true">Ver mosaico</button>
                <button class="btn-opcion" data-target="mapa" role="tab" aria-selected="false">Ver mapa</button>
            </div>
            <form action="" method="GET" class="form-busqueda-inline">
                <input type="text" name="q" placeholder="Buscar..." value="{{ request.args.get('q', '') }}">
        
                <select name="tipo">
                    <option value="">Tipo</option>
                    <option value="Casa" {% if request.args.get('tipo') == 'Casa' %}selected{% endif %}>Casa</option>
                    <option value="Departamento" {% if request.args.get('tipo') == 'Departamento' %}selected{% endif %}>Depto</option>
                </select>

                <select name="estado">
                    <option value="">Estado</option>
                    <option value="venta" {% if request.args.get('estado') == 'venta' %}selected{% endif %}>Venta</option>
                    <option value="arriendo" {% if request.args.get('estado') == 'arriendo' %}selected{% endif %}>Arriendo</option>
                </select>
        
                <div class="grupo-precio">
                    <input type="number" name="min_precio" placeholder="Min" value="{{ request.args.get('min_precio', '') }}">
                    <span>-</span>
                    <input type="number" name="max_precio" placeholder="Max" value="{{ request.args.get('max_precio', '') }}">
                </div>

                <button type="submit" class="btn-buscar">üîç</button>
                {% if request.args %}
                    <a href="{{ request.path }}" class="btn-reset" title="Limpiar">√ó</a>
                {% endif %}
            </form>
        </div>
        <section id="vista-mosaico" class="vista activa" role="tabpanel" aria-label="Mosaico de propiedades">
            {% if propiedades %}
                <div class="mosaico">
                    {% for propiedad in propiedades %}
                        {% set precio = propiedad.get('precio') or 0 %}
                        <article class="tarjeta">
                            <div class="imagen" aria-hidden="true">
                                {% set portada = propiedad.get('imagen_portada') %}
                                {% if portada %}
                                    <img src="{{ portada }}" alt="Imagen de {{ propiedad.get('nombre') }}" loading="lazy">
                                {% elif propiedad.get('img') %}
                                    <img src="data:image/jpeg;base64,{{ propiedad.get('img') }}" alt="Imagen de {{ propiedad.get('nombre', 'Propiedad sin nombre') }}" loading="lazy">
                                {% else %}
                                    <div class="imagen-placeholder">Sin imagen</div>
                                {% endif %}
                            </div>
                            <div class="contenido">
                                <h2>{{ propiedad.get('nombre', 'Propiedad sin nombre') }}</h2>
                                <p class="precio">
                                    ${{ '{:,}'.format(precio|int).replace(',', '.') }}
                                    {% if propiedad.get('estado') == 'arriendo' %} /mes{% endif %}
                                </p>
                                
                                {% if valor_uf > 0 and precio > 0 %}
                                <p class="precio-uf">
                                    <strong>(Aprox. {{ (precio / valor_uf) | round(1) }} UF)</strong>
                                </p>
                                {% endif %}
                                
                                <p class="descripcion">{{ propiedad.get('descripcion', 'Sin descripci√≥n disponible') }}</p>
                                <ul class="detalles">
                                    <li><span>Ubicaci√≥n:</span> {{ propiedad.get('localizacion', 'No indicada') }}</li>
                                    <li><span>Dormitorios:</span> {{ propiedad.get('dormitorios', 'N/D') }}</li>
                                    <li><span>Ba√±os:</span> {{ propiedad.get('ba√±os', 'N/D') }}</li>
                                    <li><span>√Årea:</span> {{ propiedad.get('area', 'N/D') }} m¬≤</li>
                                    <li><span>Tipo:</span> {{ propiedad.get('tipo', 'No especificado') }}</li>
                                </ul>
                                <div class="acciones">
                                    {% set detalle_url = propiedad.get('detalle_url') or url_for('comprador_propiedad_detalle', propiedad_id=propiedad.get('id')) %}
                                    {% if detalle_url %}
                                    <a class="btn-detalle" href="{{ detalle_url }}">Ver detalles completos</a>
                                    {% endif %}
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>

                {% if paginacion and paginacion.paginas > 1 %}
                <div class="paginacion-container">
                    <div class="paginacion">
                        {% if paginacion.actual > 1 %}
                            <a href="{{ url_for(request.endpoint, page=paginacion.actual-1, **filtros) }}" class="btn-paginacion">
                                &laquo; Anterior
                            </a>
                        {% else %}
                            <span class="btn-paginacion disabled">&laquo; Anterior</span>
                        {% endif %}

                        <span class="info-paginacion">
                            P√°gina {{ paginacion.actual }} de {{ paginacion.paginas }}
                        </span>

                        {% if paginacion.actual < paginacion.paginas %}
                            <a href="{{ url_for(request.endpoint, page=paginacion.actual+1, **filtros) }}" class="btn-paginacion">
                                Siguiente &raquo;
                            </a>
                        {% else %}
                            <span class="btn-paginacion disabled">Siguiente &raquo;</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="sin-resultados">
                    <h2>No hay propiedades publicadas en venta por ahora.</h2>
                    <p>Cuando se agreguen nuevas viviendas aparecer√°n tanto en el mosaico como en el mapa.</p>
                </div>
            {% endif %}
        </section>

        <section id="vista-mapa" class="vista" role="tabpanel" aria-label="Mapa de propiedades" hidden>
            <div id="map"></div>
            <p class="nota-mapa">Arrastra o acerca el mapa para explorar distintas zonas.</p>
        </section>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="{{ url_for('static', filename='js/loader.js') }}"></script>
    <script>
        const widget = document.getElementById('userWidget');
        const trigger = document.getElementById('userTrigger');
        const panel = document.getElementById('userPanel');
        const camposUsuario = {
            nombre: document.getElementById('userNombre'),
            email: document.getElementById('userEmail'),
            telefono: document.getElementById('userTelefono'),
            rut: document.getElementById('userRut'),
            direccion: document.getElementById('userDireccion'),
            ciudad: document.getElementById('userCiudad'),
            fecha: document.getElementById('userFecha'),
            initials: document.getElementById('userInitials'),
            shortName: document.getElementById('userShortName')
        };
// Error de archivos locales
        async function obtenerUsuarioActual() {
            try {
                const usuario = await Loader.wrap(async () => {
                    const res = await fetch('/api/me', { credentials: 'include' });
                    
                    if (res.status === 401 || res.status === 403) {
                        // Si el servidor dice "No autorizado", BORRAMOS la memoria local
                        localStorage.removeItem('usuarioActual');
                        return null;
                    }
                    

                    if (!res.ok) {
                        return null;
                    }
                    const data = await res.json();
                    // Guardamos la sesion valida
                    try { localStorage.setItem('usuarioActual', JSON.stringify(data)); } catch (e) { /* ignore */ }
                    return data;
                }, 'Recuperando tu perfil...');
                
                if (usuario) {
                    return usuario;
                }
            } catch (e) {
                console.warn('No fue posible obtener el usuario desde la sesi√≥n', e);
            }

            // Solo usamos el localStorage si NO hubo un error 401 expl√≠cito antes
            try {
                const guardado = localStorage.getItem('usuarioActual');
                if (!guardado) return null;
                return JSON.parse(guardado);
            } catch (error) {
                console.warn('No fue posible leer los datos de usuario almacenados', error);
                return null;
            }
        }

        function formatearIniciales(nombre, apellido, email) {
            const letras = [];
            if (nombre) letras.push(nombre.trim()[0]);
            if (apellido) letras.push(apellido.trim()[0]);
            if (letras.length === 0 && email) letras.push(email.trim()[0]);
            return letras.join('').toUpperCase().slice(0, 2) || 'US';
        }

        function formatearNombreCorto(nombre, email) {
            if (nombre) {
                return nombre.split(' ')[0];
            }
            if (email) {
                return email.split('@')[0];
            }
            return 'Usuario';
        }

        function formatearTipo(tipo) {
            if (!tipo) return 'Sin especificar';
            const mapa = { vendedor: 'Vendedor', comprador: 'Comprador' };
            return mapa[tipo.toLowerCase()] || tipo;
        }

        function formatearFecha(fechaIso) {
            if (!fechaIso) return 'Sin dato';
            const fecha = new Date(fechaIso);
            if (Number.isNaN(fecha.getTime())) return 'Sin dato';
            return new Intl.DateTimeFormat('es-CL', { dateStyle: 'long' }).format(fecha);
        }

        function poblarWidget(usuario) {
            if (!widget || !usuario) {
                return;
            }
            widget.hidden = false;
            camposUsuario.nombre.textContent = `${usuario.nombre || ''} ${usuario.apellido || ''}`.trim() || 'Sin nombre';
            camposUsuario.email.textContent = usuario.email || 'Sin correo';
            camposUsuario.telefono.textContent = usuario.telefono || 'Sin tel√©fono';
            camposUsuario.rut.textContent = usuario.rut || 'Sin RUT';
            camposUsuario.direccion.textContent = usuario.direccion || 'Sin direcci√≥n';
            camposUsuario.ciudad.textContent = usuario.ciudad || 'Sin ciudad';
            camposUsuario.fecha.textContent = formatearFecha(usuario.fecha_registro);
            camposUsuario.initials.textContent = formatearIniciales(usuario.nombre, usuario.apellido, usuario.email);
            camposUsuario.shortName.textContent = formatearNombreCorto(usuario.nombre, usuario.email);
        }

        function cerrarPanelUsuario() {
            if (!widget) return;
            widget.classList.remove('user-widget--abierta');
            if (trigger) trigger.setAttribute('aria-expanded', 'false');
        }
// Error de archivos locales
        function inicializarWidgetUsuario() {
            if (!widget || !trigger || !panel) {
                if (widget) widget.hidden = true;
                return;
            }
            obtenerUsuarioActual().then(usuario => {
                const navLink = document.getElementById('main-nav-link');

                if (!usuario) {
                    // MODO P√öBLICO (/ventas)
                if (widget) widget.hidden = true;
                    if (navLink) {
                        navLink.textContent = "Iniciar sesi√≥n ‚Üí";
                        navLink.href = "{{ url_for('login_view') }}";
                    }
                    return;
                }

                // MODO PRIVADO (/comprador)
                if (navLink) {
                    navLink.textContent = "‚Üê Cerrar sesi√≥n";
                    navLink.href = "{{ url_for('logout') }}"; 
                }
                    poblarWidget(usuario)

                trigger.addEventListener('click', () => {
                    const abierta = widget.classList.toggle('user-widget--abierta');
                    trigger.setAttribute('aria-expanded', abierta ? 'true' : 'false');
                });
            }).catch(err => {
                console.warn('Error al obtener usuario', err);
                if (widget) widget.hidden = true;
            });
// Error de archivos locales

            document.addEventListener('click', (evento) => {
                if (!widget.contains(evento.target)) {
                    cerrarPanelUsuario();
                }
            });

            document.addEventListener('keydown', (evento) => {
                if (evento.key === 'Escape') {
                    cerrarPanelUsuario();
                }
            });
        }

        inicializarWidgetUsuario();

        const botones = document.querySelectorAll('.btn-opcion');
        const vistas = {
            mosaico: document.getElementById('vista-mosaico'),
            mapa: document.getElementById('vista-mapa')
        };

        let mapaInicializado = false;
        const propiedadesVenta = {{ propiedades | tojson }};
        const valorUF = {{ valor_uf | tojson }};

        function activarVista(nombreVista) {
            Object.keys(vistas).forEach(vista => {
                const esActiva = vista === nombreVista;
                vistas[vista].classList.toggle('activa', esActiva);
                vistas[vista].toggleAttribute('hidden', !esActiva);
            });
            botones.forEach(boton => {
                const esActiva = boton.dataset.target === nombreVista;
                boton.classList.toggle('activa', esActiva);
                boton.setAttribute('aria-selected', esActiva ? 'true' : 'false');
            });

            if (nombreVista === 'mapa' && !mapaInicializado) {
                inicializarMapa();
                mapaInicializado = true;
            }
        }

        botones.forEach(boton => {
            boton.addEventListener('click', () => activarVista(boton.dataset.target));
        });

        function inicializarMapa() {
            if (!document.getElementById('map')) {
                return;
            }
            const mapa = L.map('map').setView([-34.984403, -71.239488], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                minZoom: 12,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapa);

            const grupo = L.layerGroup().addTo(mapa);

            if (propiedadesVenta.length === 0) {
                return;
            }

            const bounds = [];
            propiedadesVenta.forEach(propiedad => {
                const coords = propiedad.coordenadas || '';
                const portada = propiedad.imagen_portada || (propiedad.img ? `data:image/jpeg;base64,${propiedad.img}` : null);
                const partes = coords.split(',').map(parseFloat);
                if (partes.length === 2 && !Number.isNaN(partes[0]) && !Number.isNaN(partes[1])) {
                    const marker = L.marker(partes).addTo(grupo);
                    const precio = Number(propiedad.precio) || 0;
                    const esArriendo = (propiedad.estado || '').toLowerCase() === 'arriendo';
                    let precioUF = 0;
                    if (valorUF > 0 && precio > 0) {
                        // Usamos toFixed(1) para redondear a 1 decimal
                        precioUF = (precio / valorUF).toFixed(1);
                    }
                    const propietarioNombre = propiedad.propietario_nombre || null;
                    const propietarioId = propiedad.propietario || 'N/D';
                    const detalleUrl = propiedad.detalle_url || null;
                    marker.bindPopup(`
                        <strong>${propiedad.nombre || 'Propiedad sin nombre'}</strong><br>
                        Precio: $${precio.toLocaleString('es-CL')}${esArriendo ? ' /mes' : ''}<br>
                        ${precioUF > 0 ? `<strong>(Aprox. ${precioUF} UF)</strong><br>` : ''}
                        Ubicaci√≥n: ${propiedad.localizacion || 'No indicada'}<br>
                        Propietario: ${propietarioNombre || propietarioId}<br>
                        ${portada ? `<img src="${portada}" 
                            alt="Imagen de propiedad" 
                            style="max-width:150px;max-height:100px;object-fit:cover;margin-top:4px;border:1px solid #ccc;">` : ''}
                        ${detalleUrl ? `<div style="margin-top:8px;"><a href="${detalleUrl}" style="color:#2563eb;font-weight:600;">Ver detalles</a></div>` : ''}
                    `);
                    bounds.push(partes);
                }
            });

            if (bounds.length > 0) {
                mapa.fitBounds(bounds, { padding: [20, 20] });
            }
        }
    </script>
</body>
</html>
